<form action="/" method="POST" id="updateForm">
    <div class="container">
        <p class="updateMsg" id="updateMsg"></p>
        <label><b>Email: </b></label> <br>
        <text id="email"></text>
        <br><br>
        <label><b>Name: </b></label> <br>
        <text id="name"></text>
        <br><br>

        <label><b>Current Password</b></label>
        <input type="password" placeholder="Enter Current Password" name="currpsw">

        <label><b>New Password</b></label>
        <input type="password" placeholder="Enter New Password" name="psw">

        <label><b>Repeat Password</b></label>
        <input type="password" placeholder="Repeat Password" name="psw-repeat">

        <!--<label><b>First Name</b></label>-->
        <!--<input type="text" placeholder="Enter First Name" name="fname" pattern="[a-zA-Z]+(\s[a-zA-Z]+)*">-->

        <!--<label><b>Last Name</b></label>-->
        <!--<input type="text" placeholder="Enter Last Name" name="lname" pattern="[a-zA-Z]+">-->


        <label><b>Address: </b></label>
        <br><text id="addr"></text>
        <input type="text" placeholder="Enter New Address" name="address">

        <div class="clearfix">
            <button type="button" class="cancelbtn">Cancel</button>
            <button type="submit" class="updatebtn">Update</button>
        </div>
    </div>
</form>

</body>
<script>
    var email = window.sessionStorage.getItem("email");
    var usertype= window.sessionStorage.getItem('usertype');
    $("#email").text(email);
    if (usertype === "passenger")
        var sql = "select * from passenger where email = " + JSON.stringify(email);
    else
        var sql = "select * from employee where email = " +JSON.stringify(email);
    postQuery({query: sql}, fillInProfile);

    console.log("1");
    function fillInProfile(data) {
        var info = data.body.result[0];
        var fields = ["phone", "address", "dateofbirth"];
        if (usertype === "passenger")
            $("#name").text(info["pname"]);
        else
            $("#name").text(info["ename"]);

        var address = info["address"];
        if (address === null)
            address = "n/a";
        $('#addr').text("current:   " + address);
        /*
        fields.forEach(function (field) {
            var res = info[field];
            if (res !== null){
                if (field ==="phone") {
                    res = res.replace(['\-'], '');
                    res = res.replace(['\-'], '');
                }
                if (field ==="dateofbirth")
                    $("input[name="+field).val(res);
                else
                    $("input[name="+field).attr("placeholder", res);
            }
        })*/

    }

    var isLoggedIn = JSON.parse(window.sessionStorage.getItem('isLoggedIn'));
    if (!isLoggedIn) window.location.href = './';
    $(".cancelbtn")
        .click(function () {
            window.location.href = '/'
        });
    $('#updateForm').submit(function () {
        console.log("2");

        $('#updateMsg').text('');
        event.preventDefault();

        var $form = $('#updateForm'),
            currpwd = JSON.stringify($form.find("input[name='currpsw']").val()),
            password = JSON.stringify($form.find("input[name='psw']").val()),
            repassword = JSON.stringify($form.find("input[name='psw-repeat']").val()),
            address = JSON.stringify($form.find("input[name='address']").val()),
            info = [email, password, address].join(", ");
        var sql;

        console.log("3");
        if (usertype === "passenger") {
            if (address !== "") {
                sql = "update passenger set password=" + password + ", address=" + address + " where email = " + email;
            } else {
                sql = "update passenger set password=" + password + " where email = " + email;
            }
        } else {
            if (address !== "") {
                sql = "update employee set password=" + password + ", address=" + address + " where email = " + email;
            } else {
                sql = "update employee set password=" + password + " where email = " + email;
            }
        }

        console.log("4");
        if(currpwd === "" || password === "" || repassword === "") {
            var pswInDB = $.ajax({
                type: 'POST',
                url: "./profile",
                data: data,
                success: success,
                contentType: "application/json; charset=utf-8",
                async:false
            });
            if (password !== repassword) {
                return $('#updateMsg').text('Password confirmation does NOT match');
            }
        }

        postQuery()


        $.ajax({
            type: 'POST',
            url: './profile',
            data: JSON.stringify({query: sql}),
            contentType: "application/json; charset=utf-8",
            success: updateProfileHandler
        })

        console.log("6");
    });

    function updateProfileHandler(res) {
        console.log("7");
        var $form = $('#updateForm');

        if (res.code === 400) {
            return $('#updateMsg').text('Email: ' + $form.find("input[name='email']").val() + ' already exists');
        }
        console.log("5");
        return $('#updateMsg').text('Update successful!');
        window.sessionStorage.setItem("email", $form.find("input[name='email']").val());
        window.sessionStorage.setItem("isLoggedIn", true);
        window.sessionStorage.setItem("usertype", "passenger");
        window.location.href = '/'
    }
</script>